<div>
  <h1 class="form-header">Let's Capture the Vibe</h1>

  <form class="form-container" [formGroup]="ratingForm" (ngSubmit)="submitForm()">
    <!-- Bar Select -->
    <div class="bar-form-field">
      <mat-form-field class="bar-form-field">
        <mat-label>Bar</mat-label>
        <mat-select formControlName="barControl" required panelClass="ratings-select-dropdown">
          @for(bar of barList$ | async; track bar.id) {
          <mat-option [value]="bar">{{ bar.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    @if(ratingForm.controls.barControl.valid) {
    <!-- Drink Select -->
    <mat-form-field class="drink-form-field">
      <mat-label>Drink</mat-label>
      <input
        type="text"
        placeholder="Select a drink or start typing"
        aria-label="Drink Name"
        matInput
        formControlName="drinkControl"
        [matAutocomplete]="drinkAuto"
        required
      />
      <mat-autocomplete #drinkAuto="matAutocomplete" [displayWith]="drinkDisplayFn">
        @for(drink of drinkList; track drink.id) {
        <mat-option [value]="drink">{{ drink.name }}</mat-option>
        }
      </mat-autocomplete>
      <mat-hint> If you can't find your drink, we'll create a new one with your name! </mat-hint>
    </mat-form-field>
    } @if(ratingForm.controls.drinkControl.valid) {
    <!-- Rating Controls -->
    <div class="ratings-section">
      <h1>Ratings</h1>
      <div class="rating-row">
        <h2 class="rating-label">Overall</h2>
        <app-star-rating
          class="star-rating-input"
          (newRating)="setRatingControl($event, 'overallRatingControl')"
          [readonly]="false"
        ></app-star-rating>
      </div>

      <div class="rating-row">
        <h2 class="rating-label">Taste</h2>
        <app-star-rating
          class="star-rating-input"
          (newRating)="setRatingControl($event, 'tasteRatingControl')"
          [readonly]="false"
        ></app-star-rating>
      </div>

      <div class="rating-row">
        <h2 class="rating-label">Presentation</h2>
        <app-star-rating
          class="star-rating-input"
          (newRating)="setRatingControl($event, 'presentationRatingControl')"
          [readonly]="false"
        ></app-star-rating>
      </div>
    </div>

    <!-- Tag Input -->
    <mat-form-field>
      <mat-label>Tags</mat-label>
      <mat-chip-grid #tagChipGrid aria-label="drink tags" formControlName="tagControl">
        @for(tag of selectedTags(); track $index) {
        <mat-chip-row (removed)="removeTag(tag)">
          {{ tag }}
          <button matChipRemove>
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip-row>
        }
        <input
          name="currentTag"
          placeholder="Add a tag..."
          #tagInput
          formControlName="tagInputControl"
          [matChipInputFor]="tagChipGrid"
          [matAutocomplete]="tagAuto"
          [matChipInputSeparatorKeyCodes]="separatorKeyCodes"
          (matChipInputTokenEnd)="addTag($event); tagInput.value = ''"
        />
        <mat-autocomplete
          #tagAuto="matAutocomplete"
          (optionSelected)="autocompleteTagSelected($event); tagInput.value = ''"
        >
          @for(tag of filteredTags(); track tag.id) {
          <mat-option [value]="tag">{{ tag.name }}</mat-option>
          }
        </mat-autocomplete>
      </mat-chip-grid>
    </mat-form-field>
    }

    <div class="form-submit-section">
      <button matButton="outlined" type="submit" [disabled]="!ratingForm.valid">
        Submit Rating
      </button>
    </div>
  </form>

  <h4>Form Output:</h4>
  <div style="white-space: pre-wrap">{{ formOutput() ?? 'n/a' }}</div>
</div>
